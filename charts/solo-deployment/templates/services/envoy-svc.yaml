{{ range $index, $node := ($.Values.hedera.nodes) }}
{{- $envoyProxy := $node.envoyProxy | default $.Values.defaults.envoyProxy -}}
{{- $defaults := $.Values.defaults.envoyProxy }}
{{- if $envoyProxy.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: envoy-proxy-{{ $node.name }}-svc
  namespace: {{ default $.Release.Namespace $.Values.global.namespaceOverride }}
  labels:
    solo.hedera.com/type: envoy-proxy-svc
    solo.hedera.com/node-name: {{ $node.name }}
    solo.hedera.com/node-id: {{ $node.nodeId }}
    solo.hedera.com/account-id: {{ $node.accountId }}
    solo.hedera.com/prometheus-endpoint: active
    {{- include "solo.testLabels" $ | nindent 4 }}
spec:
  type: {{ $defaults.serviceType | default "ClusterIP" }}
  {{- if $node.envoyProxyStaticIP }}
  loadBalancerIP: {{ $node.envoyProxyStaticIP }}
  {{- end }}
  selector:
    app: envoy-proxy-{{ $node.name }}
  ports:
    - name: hedera-grpc-web
      port: 8080
      targetPort: 8080 # hedera-grpc-web-listener port
    - name: prometheus # port name must be prometheus for prometheus-svc-monitor
      port: 9090
      targetPort: 9090 # envoy-proxy's prometheus-listener port
{{- end }}
{{- end }}
