{{ range $index, $node := $.Values.hedera.nodes }}
{{- $hapiAppSecrets := lookup "v1" "Secret" $.Release.Namespace "network-node-hapi-app-secrets" }}
{{- $networkNodeKeySecretName := (printf "network-%s-keys-secrets" $node.name) }}
{{- $networkNodeKeySecrets := lookup "v1" "Secret" $.Release.Namespace $networkNodeKeySecretName }}
{{- $root := $node.root | default $.Values.defaults.root }}
{{- $rootExtraEnv := ($root).extraEnv | default $.Values.defaults.root.extraEnv }}
{{- $rootImage := ($node.root).image | default $.Values.defaults.root.image }}
{{- $recordStream := ($node.sidecars).recordStreamUploader | default $.Values.defaults.sidecars.recordStreamUploader }}
{{- $eventStream := ($node.sidecars).eventStreamUploader | default $.Values.defaults.sidecars.eventStreamUploader }}
{{- $blockstreamUploader := ($node.sidecars).blockstreamUploader | default $.Values.defaults.sidecars.blockstreamUploader }}
{{- $backupUploader := ($node.sidecars).backupUploader | default $.Values.defaults.sidecars.backupUploader }}
{{- $otelCollector := ($node.sidecars).otelCollector | default $.Values.defaults.sidecars.otelCollector }}
{{- $cloud := $.Values.cloud }}
{{- $defaults := $.Values.defaults }}
{{- $minioserver := (index $.Values "minio-server") }}
{{- $nodeStorage := $.Values.defaults.volumeClaims.node }}
{{- $pvcEnabled := $.Values.defaults.volumeClaims.enabled }}
{{- $initContainersLength := len $.Values.hedera.initContainers }}
{{- $cheetah := $.Values.cheetah }}
{{- $bucketPrefixString := toString $cloud.buckets.streamBucketPrefix }}
{{- $bucketPrefix := empty $bucketPrefixString | ternary "" (printf "%s/" $bucketPrefixString) }}
{{- $blockStreamBucketPrefix := printf "%sblockStreams/block-%s" $bucketPrefix $node.accountId }}
{{- $recordStreamBucketPrefix := printf "%srecordstreams/record%s" $bucketPrefix $node.accountId }}
{{ $eventStreamsBucketPrefix := printf "%seventsStreams/events_%s" $bucketPrefix $node.accountId -}}
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: network-{{ $node.name }}
  namespace: {{ default $.Release.Namespace $.Values.global.namespaceOverride }}
  labels:
    app: network-{{ $node.name }}
  {{- if $.Values.deployment.podAnnotations }}
  annotations:
    {{- $.Values.deployment.podAnnotations | toYaml | nindent 4 }}
  {{- end }}
spec:
  replicas: 1
  serviceName: "network-{{ $node.name }}"
  selector:
    matchLabels:
      app: network-{{ $node.name }}
  {{- if $pvcEnabled }}
  volumeClaimTemplates:
    {{ include "solo.volumeClaimTemplate" (dict "name" "hgcapp-blockstream-pvc" "storage" $nodeStorage.blockStreams "storageClassName" $defaults.volumeClaims.storageClassName) | nindent 4 }}
    {{ include "solo.volumeClaimTemplate" (dict "name" "hgcapp-event-streams-pvc" "storage" $nodeStorage.eventStreams "storageClassName" $defaults.volumeClaims.storageClassName) | nindent 4 }}
    {{ include "solo.volumeClaimTemplate" (dict "name" "hgcapp-record-streams-pvc" "storage" $nodeStorage.recordStreams "storageClassName" $defaults.volumeClaims.storageClassName) | nindent 4 }}
    {{ include "solo.volumeClaimTemplate" (dict "name" "hgcapp-data-onboard-pvc" "storage" $nodeStorage.dataOnboard "storageClassName" $defaults.volumeClaims.storageClassName) | nindent 4 }}
    {{ include "solo.volumeClaimTemplate" (dict "name" "hgcapp-data-saved-pvc" "storage" $nodeStorage.dataSaved "storageClassName" $defaults.volumeClaims.storageClassName) | nindent 4 }}
    {{ include "solo.volumeClaimTemplate" (dict "name" "hgcapp-data-stats-pvc" "storage" $nodeStorage.dataStats "storageClassName" $defaults.volumeClaims.storageClassName) | nindent 4 }}
    {{ include "solo.volumeClaimTemplate" (dict "name" "hgcapp-data-upgrade-pvc" "storage" $nodeStorage.dataUpgrade "storageClassName" $defaults.volumeClaims.storageClassName) | nindent 4 }}
    {{ include "solo.volumeClaimTemplate" (dict "name" "hgcapp-output-pvc" "storage" $nodeStorage.output "storageClassName" $defaults.volumeClaims.storageClassName) | nindent 4 }}
    {{ include "solo.volumeClaimTemplate" (dict "name" "hgcapp-data-config-pvc" "storage" $nodeStorage.config "storageClassName" $defaults.volumeClaims.storageClassName) | nindent 4 }}
    {{ include "solo.volumeClaimTemplate" (dict "name" "hgcapp-data-keys-pvc" "storage" $nodeStorage.keys "storageClassName" $defaults.volumeClaims.storageClassName) | nindent 4 }}
    {{ include "solo.volumeClaimTemplate" (dict "name" "hgcapp-data-libs-pvc" "storage" $nodeStorage.dataLibs "storageClassName" $defaults.volumeClaims.storageClassName) | nindent 4 }}
    {{ include "solo.volumeClaimTemplate" (dict "name" "hgcapp-data-apps-pvc" "storage" $nodeStorage.dataApps "storageClassName" $defaults.volumeClaims.storageClassName) | nindent 4 }}
    {{ include "solo.volumeClaimTemplate" (dict "name" "hgcapp-node-state-pvc" "storage" $nodeStorage.config "storageClassName" $defaults.volumeClaims.storageClassName) | nindent 4 }}
  {{- end }}
  template:
    metadata:
      labels:
        app: network-{{ $node.name }}
        solo.hedera.com/type: network-node
        solo.hedera.com/node-name: {{ $node.name }}
        solo.hedera.com/node-id: "{{ $node.nodeId }}"
        solo.hedera.com/account-id: {{ $node.accountId }}
        {{- if $node.labels }}
        {{-  $node.labels | toYaml | nindent 8 }}
        {{- end }}
        {{- if $.Values.deployment.podLabels }}
        {{- $.Values.deployment.podLabels | toYaml | nindent 8 }}
        {{- end }}
        {{- include "solo.testLabels" $ | nindent 8 }}
    spec:
      {{- if or $.Values.deployment.nodeSelector $node.nodeSelector }}
      nodeSelector:
      {{- default $node.nodeSelector $.Values.deployment.nodeSelector | toYaml | nindent 8 }}
      {{- end }}
      {{- if or $.Values.deployment.tolerations $node.tolerations }}
      tolerations:
      {{- default $node.tolerations $.Values.deployment.tolerations | toYaml | nindent 8 }}
      {{- end }}
      {{- if or $.Values.deployment.affinity $node.affinity }}
      {{- if $.Values.deployment.topologySpreadConstraints }}
      topologySpreadConstraints:
      {{- $.Values.deployment.topologySpreadConstraints | toYaml | nindent 8 }}
      {{- end }}
      affinity:
      {{- default $node.affinity $.Values.deployment.affinity | toYaml | nindent 8 }}
      {{- end }}
      {{- if or $.Values.deployment.priorityClassName $node.priorityClassName }}
      priorityClassName: {{ default $node.priorityClassName $.Values.deployment.priorityClassName }}
      {{- end }}
      terminationGracePeriodSeconds: {{ $.Values.terminationGracePeriodSeconds }}
      volumes:
        {{ include "solo.volumeTemplate" (dict "name" "hgcapp-blockstream" "claimName" (printf "%s-%s-%s" "hgcapp-blockstream-pvc-network" $node.name "0") "pvcEnabled" $pvcEnabled ) | nindent 8 }}
        {{ include "solo.volumeTemplate" (dict "name" "hgcapp-event-streams" "claimName" (printf "%s-%s-%s" "hgcapp-event-streams-pvc-network" $node.name "0") "pvcEnabled" $pvcEnabled ) | nindent 8 }}
        {{ include "solo.volumeTemplate" (dict "name" "hgcapp-record-streams" "claimName" (printf "%s-%s-%s" "hgcapp-record-streams-pvc-network" $node.name "0") "pvcEnabled" $pvcEnabled ) | nindent 8 }}
        {{ include "solo.volumeTemplate" (dict "name" "hgcapp-data-onboard" "claimName" (printf "%s-%s-%s" "hgcapp-data-onboard-pvc-network" $node.name "0") "pvcEnabled" $pvcEnabled ) | nindent 8 }}
        {{ include "solo.volumeTemplate" (dict "name" "hgcapp-data-saved" "claimName" (printf "%s-%s-%s" "hgcapp-data-saved-pvc-network" $node.name "0") "pvcEnabled" $pvcEnabled ) | nindent 8 }}
        {{ include "solo.volumeTemplate" (dict "name" "hgcapp-data-stats" "claimName" (printf "%s-%s-%s" "hgcapp-data-stats-pvc-network" $node.name "0") "pvcEnabled" $pvcEnabled ) | nindent 8 }}
        {{ include "solo.volumeTemplate" (dict "name" "hgcapp-data-upgrade" "claimName" (printf "%s-%s-%s" "hgcapp-data-upgrade-pvc-network" $node.name "0") "pvcEnabled" $pvcEnabled ) | nindent 8 }}
        {{ include "solo.volumeTemplate" (dict "name" "hgcapp-output" "claimName" (printf "%s-%s-%s" "hgcapp-output-pvc-network" $node.name "0") "pvcEnabled" $pvcEnabled ) | nindent 8 }}
        {{ include "solo.volumeTemplate" (dict "name" "hgcapp-data-config" "claimName" (printf "%s-%s-%s" "hgcapp-data-config-pvc-network" $node.name "0") "pvcEnabled" $pvcEnabled ) | nindent 8 }}
        {{ include "solo.volumeTemplate" (dict "name" "hgcapp-data-keys" "claimName" (printf "%s-%s-%s" "hgcapp-data-keys-pvc-network" $node.name "0") "pvcEnabled" $pvcEnabled ) | nindent 8 }}
        {{ include "solo.volumeTemplate" (dict "name" "hgcapp-data-libs" "claimName" (printf "%s-%s-%s" "hgcapp-data-libs-pvc-network" $node.name "0") "pvcEnabled" $pvcEnabled ) | nindent 8 }}
        {{ include "solo.volumeTemplate" (dict "name" "hgcapp-data-apps" "claimName" (printf "%s-%s-%s" "hgcapp-data-apps-pvc-network" $node.name "0") "pvcEnabled" $pvcEnabled ) | nindent 8 }}
        {{ include "solo.volumeTemplate" (dict "name" "hgcapp-node-state" "claimName" (printf "%s-%s-%s" "hgcapp-node-state-pvc-network" $node.name "0") "pvcEnabled" $pvcEnabled ) | nindent 8 }}
        {{- if $otelCollector.enabled }}
        - name: otel-collector-volume
          configMap:
            name: otel-cm-{{ $node.name }}
        {{- end }}
        {{- if $backupUploader.enabled }}
        - name: volume-for-share-version-file
          emptyDir: {}
        {{- end }}
        {{- if $hapiAppSecrets }}
        - name: network-node-hapi-app-secrets-volume
          secret:
            secretName: network-node-hapi-app-secrets
            optional: true
        {{- end }}
        - name: network-node-data-config-indexed
          configMap:
            name: network-{{ $node.name }}-data-config-cm
            optional: true
        - name: network-node-data-config
          configMap:
            name: network-node-data-config-cm
            optional: true
        - name: network-node-etc-init
          configMap:
            name: network-node-etc-cm
            optional: true
            items:
              - key: application.env
                path: application.env
        - name: network-node-etc
          emptyDir: {}
        - name: hapi-app-config-volume
          configMap:
            name: network-node-hapi-app-cm
            optional: true
        - name: shared-hapiapp
          emptyDir: {}
        - name: script-volume
          configMap:
            name: dns-validation-script
            defaultMode: 0755
        - name: solo-cheetah-config
          configMap:
            name:  cheetah-cm-{{ $node.name }}
            defaultMode: 0755
        {{- if $networkNodeKeySecrets }}
        - name: network-node-keys
          secret:
            secretName: {{ $networkNodeKeySecretName }}
            optional: true
        {{- end }}
      containers:
      # Root Container: {{ $node.name }}-root-container
      - name: {{ $root.nameOverride | default "root-container" }}
        image: {{ include "solo.container.image" (dict "image" $rootImage "Chart" $.Chart "defaults" $.Values.defaults) }}
        imagePullPolicy: {{ include "solo.images.pullPolicy" (dict "image" $rootImage "defaults" $.Values.defaults) }}
        securityContext: # need to run as root with privileged mode
          {{- include "solo.root.security.context.privileged" . | nindent 10 }}
        {{- with default $defaults.root.resources $node.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        volumeMounts:
          {{- if $backupUploader.enabled }}
          - name: volume-for-share-version-file
            mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/VERSION
            subPath: VERSION
          {{- end }}
          {{- if $.Values.hedera.configMaps.applicationEnv }}
          - name: network-node-etc
            mountPath: /etc/network-node/
          {{- end }}
          - name: shared-hapiapp
            mountPath: /shared-hapiapp
          - name: hgcapp-blockstream
            mountPath: /opt/hgcapp/blockStreams
          - name: hgcapp-event-streams
            mountPath: /opt/hgcapp/eventsStreams
          - name: hgcapp-record-streams
            mountPath: /opt/hgcapp/recordStreams
          - name: hapi-app-config-volume
            mountPath: /etc/network-node/config
          - name: hgcapp-data-onboard
            mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/data/onboard
          - name: hgcapp-data-saved
            mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/data/saved
          - name: hgcapp-data-stats
            mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/data/stats
          - name: hgcapp-data-upgrade
            mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/data/upgrade
          - name: hgcapp-output
            mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/output
          - name: hgcapp-data-config
            mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/data/config
          - name: hgcapp-data-keys
            mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/data/keys
          - name: hgcapp-data-libs
            mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/data/lib
          - name: hgcapp-data-apps
            mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/data/apps
          - name: hgcapp-node-state
            mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/state
        env:
          # these only get used as root, to set them for hedera user ID they need to be populated in the
          # /etc/network-node/application.env, if you want the docker container to use them they need to also be in
          # solo-containers > network-node.service > PassEnvironment
          - name: CONSENSUS_NODE_ID
            value: "{{ $node.nodeId }}"
          - name: CONSENSUS_NODE_ALIAS
            value: {{ $node.name }}
          {{- include "solo.defaultEnvVars" . | nindent 10 }}
          {{- with $rootExtraEnv }}
            {{- toYaml . | nindent 10 }}
          {{- end }}
    {{- if $cheetah.deployment.single }}
      # Sidecar: {{ $node.name }}-cheetah-stream-uploader
      - name: {{ default "cheetahstream-uploader" $cheetah.deployment.nameOverride }}
        image: {{ include "solo.container.image" (dict "image" $cheetah.image "Chart" $.Chart ) }}
        imagePullPolicy: {{ include "solo.images.pullPolicy" (dict "image" $cheetah.image ) }}
        securityContext:
          {{- include "solo.hedera.security.context" . | nindent 10 }}
        command:
          - /app/bin/cheetah
          - upload
          - --config
          - /app/config/cheetah.yaml
        volumeMounts:
          - name: hgcapp-blockstream
            mountPath: /opt/hgcapp/blockStreams/block-{{ $node.accountId }}
            subPath: block-{{ $node.accountId }}
          - name: hgcapp-record-streams
            mountPath: /opt/hgcapp/recordStreams/record{{ $node.accountId }}
            subPath: record{{ $node.accountId }}
          - name: hgcapp-record-streams-sidecar
            mountPath: /opt/hgcapp/recordStreams/record{{ $node.accountId }}/sidecar
          - name: hgcapp-event-streams
            mountPath: /opt/hgcapp/eventsStreams/events_{{ $node.accountId }}
            subPath: events_{{ $node.accountId }}
          - name: solo-cheetah-config
            subPath: cheetah.yaml
            mountPath: /app/config/cheetah.yaml
            readOnly: true
        ports:
          - name: pprof
            containerPort: 6061
            protocol: TCP
          - name: stats
            containerPort: 6060
            protocol: TCP
        env:
          {{- if $.Values.cloud.minio.enabled }}
          - name: S3_ENABLED
            value: "true"
          - name: S3_BUCKET_NAME
            value: {{ $cloud.buckets.streamBucket | quote }}
          - name: S3_BUCKET_REGION
            value: {{ $cloud.buckets.streamBucketRegion | quote }}
          - name: S3_BLOCK_STREAMS_BUCKET_PREFIX
            value: {{ $blockStreamBucketPrefix | quote }}
          - name: S3_RECORD_STREAMS_BUCKET_PREFIX
            value: {{ $recordStreamBucketPrefix | quote }}
          - name: S3_EVENTS_STREAMS_BUCKET_PREFIX
            value: {{ $eventStreamsBucketPrefix | quote }}
          - name: S3_ENDPOINT
            value: "{{ $minioserver.tenant.name }}-hl:9000" # do not use http:// here instead use useSsl=false
          - name: S3_USE_SSL
            value: "false"
          {{- else if $.Values.cloud.s3.enabled }}
          - name: S3_ENABLED
            value: "true"
          - name: S3_BUCKET_NAME
            value: {{ $cloud.buckets.streamBucket | quote }}
          - name: S3_BUCKET_REGION
            value: {{ $cloud.buckets.streamBucketRegion | quote }}
          - name: S3_BLOCK_STREAMS_BUCKET_PREFIX
            value: {{ $blockStreamBucketPrefix | quote }}
          - name: S3_RECORD_STREAMS_BUCKET_PREFIX
            value: {{ $recordStreamBucketPrefix | quote }}
          - name: S3_EVENTS_STREAMS_BUCKET_PREFIX
            value: {{ $eventStreamsBucketPrefix | quote }}
          - name: S3_ENDPOINT
            valueFrom:
              secretKeyRef:
                name: uploader-mirror-secrets
                key: S3_ENDPOINT # do not use https:// here instead use useSsl=true
          - name: S3_USE_SSL
            value: "true"
          {{- end }}
          {{- if $.Values.cloud.gcs.enabled }}
          - name: GCS_ENABLED
            value: "true"
          - name: GCS_BUCKET_NAME
            value: {{ $cloud.buckets.streamBucket | quote }}
          - name: GCS_BUCKET_REGION
            value: {{ $cloud.buckets.streamBucketRegion | quote }}
          - name: GCS_BLOCK_STREAMS_BUCKET_PREFIX
            value: {{ $blockStreamBucketPrefix | quote }}
          - name: GCS_RECORD_STREAMS_BUCKET_PREFIX
            value: {{ $recordStreamBucketPrefix | quote }}
          - name: GCS_EVENTS_STREAMS_BUCKET_PREFIX
            value: {{ $eventStreamsBucketPrefix | quote }}
          - name: GCS_ENDPOINT
            valueFrom:
              secretKeyRef:
                name: uploader-mirror-secrets
                key: GCS_ENDPOINT
          - name: GCS_USE_SSL
            value: "true"
          {{- end }}
        envFrom:
          - secretRef:
              name: uploader-mirror-secrets
          {{- with default $defaults.sidecars.blockstreamUploader.resources $blockstreamUploader.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
    {{- else }}
      {{- if $blockstreamUploader.enabled }}
      # Sidecar: {{ $node.name }}-blockstream-uploader
      - name: {{ default "blockstream-uploader" $blockstreamUploader.nameOverride }}
        image: {{ include "solo.container.image" (dict "image" $cheetah.image "Chart" $.Chart ) }}
        imagePullPolicy: {{ include "solo.images.pullPolicy" (dict "image" $cheetah.image ) }}
        securityContext:
          {{- include "solo.hedera.security.context" . | nindent 10 }}
        command:
          - /app/bin/cheetah
          - upload
          - --config
          - /app/config/cheetah.yaml
        volumeMounts:
          - name: hgcapp-blockstream
            mountPath: /opt/hgcapp/blockStreams/block-{{ $node.accountId }}
            subPath: block-{{ $node.accountId }}
          - name: solo-cheetah-config
            subPath: cheetah-block-streams.yaml
            mountPath: /app/config/cheetah.yaml
            readOnly: true
        ports:
          - name: pprof
            containerPort: 6061
            protocol: TCP
          - name: stats
            containerPort: 6060
            protocol: TCP
        env:
          {{- if $.Values.cloud.minio.enabled }}
          - name: S3_ENABLED
            value: "true"
          - name: S3_BUCKET_NAME
            value: {{ $cloud.buckets.streamBucket | quote }}
          - name: S3_BUCKET_REGION
            value: {{ $cloud.buckets.streamBucketRegion | quote }}
          - name: S3_BLOCK_STREAMS_BUCKET_PREFIX
            value: {{ $blockStreamBucketPrefix | quote }}
          - name: S3_ENDPOINT
            value: "{{ $minioserver.tenant.name }}-hl:9000" # do not use http:// here instead use useSsl=false
          - name: S3_USE_SSL
            value: "false"
          {{- else if $.Values.cloud.s3.enabled }}
          - name: S3_ENABLED
            value: "true"
          - name: S3_BUCKET_NAME
            value: {{ $cloud.buckets.streamBucket | quote }}
          - name: S3_BUCKET_REGION
            value: {{ $cloud.buckets.streamBucketRegion | quote }}
          - name: S3_BLOCK_STREAMS_BUCKET_PREFIX
            value: {{ $blockStreamBucketPrefix | quote }}
          - name: S3_ENDPOINT
            valueFrom:
              secretKeyRef:
                name: uploader-mirror-secrets
                key: S3_ENDPOINT # do not use https:// here instead use useSsl=true
          - name: S3_USE_SSL
            value: "true"
          {{- end }}
          {{- if $.Values.cloud.gcs.enabled }}
          - name: GCS_ENABLED
            value: "true"
          - name: GCS_BUCKET_NAME
            value: {{ $cloud.buckets.streamBucket | quote }}
          - name: GCS_BUCKET_REGION
            value: {{ $cloud.buckets.streamBucketRegion | quote }}
          - name: GCS_BLOCK_STREAMS_BUCKET_PREFIX
            value: {{ $blockStreamBucketPrefix | quote }}
          - name: GCS_ENDPOINT
            valueFrom:
              secretKeyRef:
                name: uploader-mirror-secrets
                key: GCS_ENDPOINT
          - name: GCS_USE_SSL
            value: "true"
          {{- end }}
        envFrom:
          - secretRef:
              name: uploader-mirror-secrets
          {{- with default $defaults.sidecars.blockstreamUploader.resources $blockstreamUploader.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- end }}

      {{- if $recordStream.enabled }}
      # Sidecar: {{ $node.name }}-record-stream-uploader
      - name: {{ default "record-stream-uploader" $recordStream.nameOverride }}
        image: {{ include "solo.container.image" (dict "image" $cheetah.image "Chart" $.Chart ) }}
        imagePullPolicy: {{ include "solo.images.pullPolicy" (dict "image" $cheetah.image ) }}
        securityContext:
          {{- include "solo.hedera.security.context" . | nindent 10 }}
        command:
          - /app/bin/cheetah
          - upload
          - --config
          - /app/config/cheetah.yaml
        volumeMounts:
          - name: hgcapp-record-streams
            mountPath: /opt/hgcapp/recordStreams/record{{ $node.accountId }}
            subPath: record{{ $node.accountId }}
          - name: solo-cheetah-config
            subPath: cheetah-record-streams.yaml
            mountPath: /app/config/cheetah.yaml
            readOnly: true
        ports:
          - name: pprof
            containerPort: 6061
            protocol: TCP
          - name: stats
            containerPort: 6060
            protocol: TCP
        env:
          {{ $bucketPrefix := printf "%s/recordstreams/record%s" $cloud.buckets.streamBucketPrefix $node.accountId }}
          {{- if $.Values.cloud.minio.enabled }}
          - name: S3_ENABLED
            value: "true"
          - name: S3_BUCKET_NAME
            value: {{ $cloud.buckets.streamBucket | quote }}
          - name: S3_BUCKET_REGION
            value: {{ $cloud.buckets.streamBucketRegion | quote }}
          - name: S3_RECORD_STREAMS_BUCKET_PREFIX
            value: {{ $recordStreamBucketPrefix | quote }}
          - name: S3_ENDPOINT
            value: "{{ $minioserver.tenant.name }}-hl:9000" # do not use http:// here instead use useSsl=false
          - name: S3_USE_SSL
            value: "false"
          {{- else if $.Values.cloud.s3.enabled }}
          - name: S3_ENABLED
            value: "true"
          - name: S3_BUCKET_NAME
            value: {{ $cloud.buckets.streamBucket | quote }}
          - name: S3_BUCKET_REGION
            value: {{ $cloud.buckets.streamBucketRegion | quote }}
          - name: S3_RECORD_STREAMS_BUCKET_PREFIX
            value: {{ $recordStreamBucketPrefix | quote }}
          - name: S3_ENDPOINT
            valueFrom:
              secretKeyRef:
                name: uploader-mirror-secrets
                key: S3_ENDPOINT # do not use https:// here instead use useSsl=true
          - name: S3_USE_SSL
            value: "true"
          {{- end }}
          {{- if $.Values.cloud.gcs.enabled }}
          - name: GCS_ENABLED
            value: "true"
          - name: GCS_BUCKET_NAME
            value: {{ $cloud.buckets.streamBucket | quote }}
          - name: GCS_BUCKET_REGION
            value: {{ $cloud.buckets.streamBucketRegion | quote }}
          - name: GCS_RECORD_STREAMS_BUCKET_PREFIX
            value: {{ $recordStreamBucketPrefix | quote }}
          - name: GCS_ENDPOINT
            valueFrom:
              secretKeyRef:
                name: uploader-mirror-secrets
                key: GCS_ENDPOINT
          - name: GCS_USE_SSL
            value: "true"
          {{- end }}
        envFrom:
          - secretRef:
              name: uploader-mirror-secrets
        {{- with default $defaults.sidecars.recordStreamUploader.resources $recordStream.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- end }}

      {{- if $eventStream.enabled }}
        # Sidecar: {{ $node.name }}-event-stream-uploader
      - name: {{ default "event-stream-uploader" $eventStream.nameOverride }}
        image: {{ include "solo.container.image" (dict "image" $cheetah.image "Chart" $.Chart ) }}
        imagePullPolicy: {{ include "solo.images.pullPolicy" (dict "image" $cheetah.image ) }}
        securityContext:
          {{- include "solo.hedera.security.context" . | nindent 10 }}
        command:
          - /app/bin/cheetah
          - upload
          - --config
          - /app/config/cheetah.yaml
        volumeMounts:
          - name: hgcapp-event-streams
            mountPath: /opt/hgcapp/eventsStreams/events_{{ $node.accountId }}
            subPath: events_{{ $node.accountId }}
          - name: solo-cheetah-config
            subPath: cheetah-events-streams.yaml
            mountPath: /app/config/cheetah.yaml
            readOnly: true
        ports:
          - name: pprof
            containerPort: 6061
            protocol: TCP
        env:
          {{- if $.Values.cloud.minio.enabled }}
          - name: S3_ENABLED
            value: "true"
          - name: S3_BUCKET_NAME
            value: {{ $cloud.buckets.streamBucket | quote }}
          - name: S3_BUCKET_REGION
            value: {{ $cloud.buckets.streamBucketRegion | quote }}
          - name: S3_EVENTS_STREAMS_BUCKET_PREFIX
            value: {{ $eventStreamsBucketPrefix | quote }}
          - name: S3_ENDPOINT
            value: "{{ $minioserver.tenant.name }}-hl:9000" # do not use http:// here instead use useSsl=false
          - name: S3_USE_SSL
            value: "false"
          {{- else if $.Values.cloud.s3.enabled }}
          - name: S3_ENABLED
            value: "true"
          - name: S3_BUCKET_NAME
            value: {{ $cloud.buckets.streamBucket | quote }}
          - name: S3_BUCKET_REGION
            value: {{ $cloud.buckets.streamBucketRegion | quote }}
          - name: S3_EVENTS_STREAMS_BUCKET_PREFIX
            value: {{ $eventStreamsBucketPrefix | quote }}
          - name: S3_ENDPOINT
            valueFrom:
              secretKeyRef:
                name: uploader-mirror-secrets
                key: S3_ENDPOINT # do not use https:// here instead use useSsl=true
          - name: S3_USE_SSL
            value: "true"
          {{- end }}
          {{- if $.Values.cloud.gcs.enabled }}
          - name: GCS_ENABLED
            value: "true"
          - name: GCS_BUCKET_NAME
            value: {{ $cloud.buckets.streamBucket | quote }}
          - name: GCS_BUCKET_REGION
            value: {{ $cloud.buckets.streamBucketRegion | quote }}
          - name: GCS_EVENTS_STREAMS_BUCKET_PREFIX
            value: {{ $eventStreamsBucketPrefix | quote }}
          - name: GCS_ENDPOINT
            valueFrom:
              secretKeyRef:
                name: uploader-mirror-secrets
                key: GCS_ENDPOINT
          - name: GCS_USE_SSL
            value: "true"
          {{- end }}
        envFrom:
          - secretRef:
              name: uploader-mirror-secrets
        {{- with default $defaults.sidecars.eventStreamUploader.resources $eventStream.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- end }}

  {{- end }}

      {{- if $backupUploader.enabled }}
      # Sidecar: {{ $node.name }}-backup-uploader
      - name: {{ default "backup-uploader" $backupUploader.nameOverride }}
        image: {{ include "solo.container.image" (dict "image" $backupUploader.image "Chart" $.Chart "defaults" $defaults.sidecars.backupUploader) }}
        imagePullPolicy: {{ include "solo.images.pullPolicy" (dict "image" $backupUploader.image "defaults" $defaults.sidecars.backupUploader ) }}
        securityContext: # backup.sh needs permission to create file at root directory
          {{- include "solo.root.security.context.privileged" . | nindent 10 }}
        volumeMounts:
          - name: volume-for-share-version-file
            mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/VERSION
            subPath: VERSION
          - name: hgcapp-data-saved
            mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/data/saved
          - name: hgcapp-data-stats
            mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/data/stats
        env:
          - name: AWS_ACCESS_KEY_ID
            valueFrom:
              secretKeyRef:
                name: backup-uploader-secrets
                key: AWS_ACCESS_KEY_ID
          - name: AWS_SECRET_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: backup-uploader-secrets
                key: AWS_SECRET_ACCESS_KEY
          - name: RCLONE_CONFIG_BACKUPS_ENDPOINT
            valueFrom:
              secretKeyRef:
                name: backup-uploader-secrets
                key: RCLONE_CONFIG_BACKUPS_ENDPOINT
          - name: RCLONE_CONFIG_BACKUPS_REGION
            valueFrom:
              secretKeyRef:
                name: backup-uploader-secrets
                key: RCLONE_CONFIG_BACKUPS_REGION
          - name: RCLONE_CONFIG_BACKUPS_TYPE
            valueFrom:
              secretKeyRef:
                name: backup-uploader-secrets
                key: RCLONE_CONFIG_BACKUPS_TYPE
          - name: RCLONE_CONFIG_BACKUPS_PROVIDER
            valueFrom:
              secretKeyRef:
                name: backup-uploader-secrets
                key: RCLONE_CONFIG_BACKUPS_PROVIDER
          - name: BACKUP_UPLOADER_BUCKET_1
            value: {{ default $defaults.sidecars.backupUploader.config.backupBucket ($backupUploader.config).backupBucket | quote }}
        {{- with default $defaults.sidecars.backupUploader.resources $backupUploader.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- end }}

      {{- if $otelCollector.enabled }}
      # Sidecar: {{ $node.name }}-otel-collector
      - name: {{ default "otel-collector" $otelCollector.nameOverride }}
        image: {{ include "solo.container.image" (dict "image" $otelCollector.image "Chart" $.Chart "defaults" $defaults.sidecars.otelCollector) }}
        imagePullPolicy: {{ include "solo.images.pullPolicy" (dict "image" $otelCollector.image "defaults" $defaults.sidecars.otelCollector) }}
        securityContext:
          {{- include "solo.root.security.context" . | nindent 10 }}
        ports:
          - name: otlp # otel port defined in otel-collector config
            containerPort: 4317
            protocol: TCP
          - name: prometheus
            containerPort: 9090
            protocol: TCP
          - name: health # for otel-collector liveness check
            containerPort: 13133
            protocol: TCP
          - name: metrics # default metrics port exposed by the otel-collector itself
            containerPort: 8888
            protocol: TCP
        livenessProbe:
          httpGet:
            path: /
            port: health
        readinessProbe:
          httpGet:
            path: /
            port: health
        volumeMounts:
          - name: otel-collector-volume
            mountPath: /etc/otelcol-contrib/config.yaml
            subPath: config.yaml #key in the configmap
            readOnly: true
        {{- with default $defaults.sidecars.otelCollector.resources $otelCollector.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- end }}

      initContainers:
        {{- if $backupUploader.enabled }}
        # create empty VERSION file before any volume mounted
        # otherwise VERSION will be mounted as directory by backup-uploader
        # since root-container has not created the file yet during the mount
        - name: init-version-file
          image: busybox:1.36.1
          command: ["sh", "-c", "echo '' > /mnt/VERSION"]
          volumeMounts:
            - name: volume-for-share-version-file
              mountPath: /mnt
        {{- end }}

        - name: init-streams-directories
          image: busybox:1.36.1
          command:
            - "/bin/sh"
            - "-c"
            - |
              mkdir -p /opt/hgcapp/recordStreams/record{{ $node.accountId }}/uploader-stats
              mkdir -p /opt/hgcapp/recordStreams/record{{ $node.accountId }}/sidecar
              chmod -R 777 /opt/hgcapp/recordStreams # cheetah needs write access to delete files after upload

              mkdir -p /opt/hgcapp/blockStreams/block-{{ $node.accountId }}
              chmod 777 /opt/hgcapp/blockStreams
              chmod -R 777 /opt/hgcapp/blockStreams # cheetah needs write access to delete files after upload

              mkdir -p /opt/hgcapp/eventsStreams/events_{{ $node.accountId }}
              chmod -R 777 /opt/hgcapp/eventsStreams # cheetah needs write access to delete files after upload
          volumeMounts:
            - name: hgcapp-record-streams
              mountPath: /opt/hgcapp/recordStreams
            - name: hgcapp-blockstream
              mountPath: /opt/hgcapp/blockStreams
            - name: hgcapp-event-streams
              mountPath: /opt/hgcapp/eventsStreams

        - name: init-copier
          image: busybox:1.36.1
          command: ["sh", "-c"]
          args:
            - |
              {{- if $hapiAppSecrets }}
              cp -L /data/secret/hedera-{{ $node.name }}.crt /shared-hapiapp/hedera.crt
              cp -L /data/secret/hedera-{{ $node.name }}.key /shared-hapiapp/hedera.key
              ls -la /shared-hapiapp
              {{- end }}

              cp -rL /data/config/* /opt/hgcapp/services-hedera/HapiApp2.0/data/config

              if [ -f /data/config/genesis-network.json ]; then
                cp -L /data/config/genesis-network.json /opt/hgcapp/services-hedera/HapiApp2.0/data/config
              fi
              if [ -f /data/config/genesis-throttles.json ]; then
                cp -L /data/config/genesis-throttles.json /opt/hgcapp/services-hedera/HapiApp2.0/data/config
              fi
              if [ -f /data/config/block-node/block-nodes.json ]; then
                cp -L /data/config/block-node/block-nodes.json /opt/hgcapp/services-hedera/HapiApp2.0/data/config/block-nodes.json
              fi

              chmod 755 -R /opt/hgcapp/services-hedera/HapiApp2.0/data/config
              ls -la /opt/hgcapp/services-hedera/HapiApp2.0/data/config

              {{- if $networkNodeKeySecrets }}
              cp /opt/hgcapp/keys/* /opt/hgcapp/services-hedera/HapiApp2.0/data/keys
              chmod 755 -R /opt/hgcapp/services-hedera/HapiApp2.0/data/keys
              ls -la /opt/hgcapp/services-hedera/HapiApp2.0/data/keys
              {{- end }}

              chmod 755 -R /opt/hgcapp/services-hedera/HapiApp2.0/data

              {{- if $.Values.hedera.configMaps.applicationEnv }}
              # copy in the application.env to supply the environment variables to the application, will need
              # CONSENSUS_NODE_ID set to the unique Node ID with hedera platform v0.59+
              cp /etc/network-node-temp/* /etc/network-node
              chmod -R 755 /etc/network-node
              chown -R 2000:2000 /etc/network-node
              touch /etc/network-node/application.env
              {{- end }}
          volumeMounts:
            {{- if $networkNodeKeySecrets }}
            - name: hgcapp-data-keys
              mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/data/keys
            - name: network-node-keys
              mountPath: /opt/hgcapp/keys
            {{- end }}
            {{- if $hapiAppSecrets }}
            - name: network-node-hapi-app-secrets-volume
              mountPath: /data/secret
            {{- end }}
            - name: network-node-data-config
              mountPath: /data/config
            - name: network-node-data-config-indexed
              mountPath: /data/config/block-node
            - name: hgcapp-data-config
              mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/data/config
            {{- if $.Values.hedera.configMaps.applicationEnv }}
            - name: network-node-etc-init
              mountPath: /etc/network-node-temp/
            - name: network-node-etc
              mountPath: /etc/network-node/
            {{- end }}
            - name: shared-hapiapp
              mountPath: /shared-hapiapp
            - name: hgcapp-data-libs
              mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/data/lib
            - name: hgcapp-data-apps
              mountPath: /opt/hgcapp/services-hedera/HapiApp2.0/data/apps
        {{- if $.Values.deployment.init.enableDnsValidation }}
        - name: init-hedera
          image: curlimages/curl:8.9.1
          command: ["/bin/sh", "-c", "/script/dns-validation.sh"]
          volumeMounts:
            - name: script-volume
              mountPath: /script
        {{- end }}
      {{- if gt $initContainersLength 0 }}
        {{- toYaml $.Values.hedera.initContainers | nindent 8 }}
      {{- end }}
{{ end }}
